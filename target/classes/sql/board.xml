<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<mapper namespace="board">

	<!-- 게시판, 삭제여부, 검색 조건 -->
	<sql id="includeBoard">
		WHERE groupid=#{groupid} AND isdeleted=0
		<if test="searchKeyword!=null and searchKeyword!='' and searchTypeArray!=null and searchTypeArray!=''">
			AND
			<foreach item="item" index="index" open="(" close=")" separator="or" collection="searchTypeArray">
				${item} LIKE CONCAT('%',
				#{searchKeyword},'%' )
			</foreach>
		</if>
	</sql>
	<!-- 게시판 리스트 (검색 조건을 포함)-->
	<select id="selectBoardList" resultType="devsepark.board.model.BoardArticle" parameterType="devsepark.board.common.SearchVo">
		SELECT id, title, writer, date_format(date,'%Y-%m-%d') date, hit
		FROM
		board_article
		<include refid="includeBoard" />
		ORDER BY id DESC
		LIMIT ${rowStart - 1}, ${displayRowCount}
	</select>
	
	<!-- 게시글 전체 수 (검색 조건을 포함) -->
	<select id="selectBoardCount" resultType="Integer" parameterType="devsepark.board.common.SearchVo">
		SELECT COUNT(*)
		FROM board_article
		<include refid="includeBoard" />
	</select>
	
	<!-- 게시글 생성 -->
	<insert id="insertBoard" parameterType="devsepark.board.model.BoardArticle">
		<selectKey resultType="String" keyProperty="articleid" order="BEFORE">
            SELECT IFNULL(MAX(id),0)+1 FROM board_article
        </selectKey>

		INSERT INTO
		board_article(groupid, id, title, writer, content, date, hit, isdeleted)
		VALUES
		(#{groupid}, #{id}, #{title}, #{writer}, #{content}, NOW(), 0, 0 )
	</insert>
	
	<!-- 게시글 수정 -->
	<update id="updateBoard" parameterType="devsepark.board.model.BoardArticle">
		UPDATE board_article
		SET
		title=#{title}
		, writer=#{writer}
		, content=#{content}
		WHERE id=#{id}
		AND
		isdeleted=0
	</update>
	
	<!-- 게시글 조회수 1증가 -->
	<update id="updateBoardHit" parameterType="String">
		UPDATE board_article
		SET
		hit = hit +1
		WHERE id =#{id}
	</update>
	
	<!-- 게시글 읽기 -->
	<select id="selectBoardOne" parameterType="String" resultType="devsepark.board.model.BoardArticle">
		SELECT groupid, id, title, writer, content,
		DATE_FORMAT(date,'%Y-%m-%d') date
		FROM board_article
		WHERE id=#{id}
		AND
		isdeleted=0
	</select>
	
	<!-- 게시글 삭제 -->
	<delete id="deleteBoardOne" parameterType="String">
		UPDATE board_article
		SET
		isdeleted=1
		WHERE id=#{id}
	</delete>
	<!-- 댓글 입력. -->
	<insert id="insertBoardComment" parameterType="devsepark.board.model.BoardComment">
		<selectKey resultType="String" keyProperty="commentid" order="BEFORE">
			SELECT IFNULL(MAX(id),0)+1 FROM board_comment
		</selectKey>

		INSERT INTO board_comment(articleid, id, writer, isdeleted,
		content, date)
		VALUES (#{articleid}, #{id}, #{writer}, 0, #{content}, NOW())
	</insert>
	
	<!-- 댓글 수정 -->
	<update id="updateBoardComment" parameterType="devsepark.board.model.BoardComment">
		UPDATE board_comment
		SET content=#{content}
		WHERE id=#{id}
	</update>
	
	<!-- 댓글 리스트 -->
    <select id="selectBoardCommentList" resultType="devsepark.board.model.BoardComment" parameterType="String">
        SELECT articleid, id, writer, isdeleted, content, date 
          FROM board_comment
         WHERE articleid=#{articleid} AND isdeleted=0
         ORDER BY id
    </select>
    
	<!-- 댓글 삭제 -->
	<update id="deleteBoardComment" parameterType="String"> 
        UPDATE board_comment
           SET isdeleted=1
         WHERE commentid=#{commentid}       
    </update>
	<!-- 게시판 그룹 읽어오기 -->
	<select id="selectBoardGroupOne" parameterType="String" resultType="devsepark.board.model.BoardGroup">
        SELECT id, simplename, detailedname, isavailable, iscommentable, readonly
          FROM board_group
         WHERE isdeleted=0 AND simplename=#{simplename} 
    </select> 
    
    <!-- 게시판 그룹 리스트 -->
	<select id="selectBoardGroupList" resultType="devsepark.board.model.BoardGroup">
        SELECT id, simplename, detailedname, parent, isavailable
          FROM board_group
         WHERE isdeleted=0
    </select> 
</mapper>

